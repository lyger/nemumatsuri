import React, { useContext, useEffect } from 'react';
import { motion, useAnimation } from 'framer-motion';
import { ColorContext } from '../../colorscheme';
import Shoulders from './shoulders';
import { SceneContext } from '../../scene';

function SideTail({ rate, swing }) {
  const [{ matsuriColors } ] = useContext(ColorContext);
  const sideTailSwing = swing * 0.8;
  const variants = {
    sideTail: {rotate: [sideTailSwing, -sideTailSwing, sideTailSwing], transition: {ease: 'easeInOut', delay: rate * 0.15, duration: rate, loop: Infinity}},
  };
  return (
    <motion.g
      variants={variants}
      animate={['sideTail', `r${rate}s${swing}`]}
      style={{originX: '930px', originY: '245px'}}>

      <defs>
        <path
          id="hair_sidetail"
          d="m 906.99568,257.27677 c 0,0 -8.69295,-43.75566 12.41745,-55.13587 21.11031,-11.38021 55.37288,-7.58139 82.55167,31.15826 27.179,38.73966 16.9135,64.49105 16.9935,77.31777 0.08,12.82671 9.0949,29.11697 9.0949,29.11697 0,0 -6.3687,1.91449 -10.9835,0.29877 -4.6147,-1.61575 -7.8637,-5.73962 -7.8637,-5.73962 0,0 -4.7579,17.59311 -0.2865,38.41764 4.4714,20.82458 1.5655,45.31311 -13.85897,56.03292 -15.42444,10.71981 -31.29936,7.23382 -31.29936,7.23382 0,0 4.2177,-4.03892 6.3913,-8.85447 2.17358,-4.81555 1.96393,-12.05014 1.96393,-12.05014 0,0 -2.56657,0.0802 -5.32256,2.06408 -2.43473,1.75269 -4.40974,4.24417 -4.40974,4.24417 0,0 -3.44387,-7.27583 -3.16777,-16.64677 0.35286,-11.97428 0.89399,-43.71375 -15.16184,-74.06634 -16.95044,-32.0438 -37.0588,-73.3912 -37.0588,-73.3912 0,0 0,0 0,0"
          style={{fill: matsuriColors.HAIR}} />

        <clipPath id="hair_sidetail_clip">
          <use href="#hair_sidetail" />
        </clipPath>
      </defs>

      <use href="#hair_sidetail" />
      <path
        id="hair_sidetail_shadow"
        clipPath="url(#hair_sidetail_clip)"
        d="m 926.60301,216.70019 c -1.71397,-0.0293 -3.34131,0.1084 -4.85303,0.42481 -16.125,3.375 -11.99999,26.625 -11.99999,26.625 0,0 9,43.12499 24.00001,109.12501 C 948.74998,418.875 958.12498,444 958.12498,444 c 0,0 45.00002,-1.50001 57.75002,-25.87499 12.75,-24.375 -8.25,-52.12502 -8.25,-52.12502 0,0 4.875,16.12502 -2.25,33.375 -6.85073,16.58608 -19.5,19.50001 -19.5,19.50001 0,0 8.42091,-22.69066 4.125,-41.24999 -6.17386,-26.67237 -12.17041,-36.3547 -12.75001,-59.25002 -0.74999,-29.625 5.62499,-38.24999 -2.25,-62.99999 -7.1367,-22.42969 -31.82828,-38.39104 -48.39698,-38.67481 0,0 0,0 0,0 M 1011.375,310.5 c 0,0 0.5273,5.80819 -0.1874,11.81251 -0.9374,7.87499 -2.25,14.24999 -2.25,14.24999 0,0 23.4375,16.87499 23.4375,16.87499 0,0 -4.875,-30.18747 -4.875,-30.18747 0,0 -1.5,1.49998 -7.875,-3.37501 -5.3037,-4.05575 -8.25,-9.375 -8.25,-9.375 0,0 0,0 0,0"
        style={{fill: matsuriColors.HAIR_SHADOW}}/>

    </motion.g>
  );
}

export default function Head() {
  const [ { rate, swing } ] = useContext(SceneContext);
  const [ { matsuriColors } ] = useContext(ColorContext);
  const rerenderKey = `r${rate}s${swing}`;
  const headSwing = swing * 0.5;
  const breathRate = rate * 1.4;
  const variants = {
    sway: {
      rotate: [-headSwing, headSwing, -headSwing],
      transition: {ease: 'easeInOut', duration: breathRate * 0.7, repeatDelay: breathRate * 0.3, loop: Infinity},
    },
  };
  const style = {y: '5px', originX: '910px', originY: '445px'}
  const ahogeVariants = {
    largeFlick: {
      rotate: 0,
      transition: {type: 'spring', velocity: 200, stiffness: 150, damping: 2, mass: 0.3},
    },
    smallFlick: {
      rotate: 0,
      transition: {type: 'spring', velocity: 100, stiffness: 150, damping: 3, mass: 0.3, delay: rate * 1.8},
    },
  };
  const ahogeControl = useAnimation();
  const ahogeLoop = () => { ahogeControl.start('smallFlick').then(ahogeLoop) };
  useEffect(ahogeLoop, [ahogeControl, rate]);
  const faceVariants = {
    squashX: {
      scaleX: 1,
      transition: {type: 'spring', velocity: 0.4, stiffness: 150, damping: 2, mass: 0.5},
    },
    squashY: {
      scaleY: 1,
      transition: {type: 'spring', velocity: 0.4, stiffness: 150, damping: 2, mass: 0.5},
    },
  };
  const faceControl = useAnimation();
  return (
    <React.Fragment>

      <motion.g
        animate={['sway', rerenderKey]}
        style={style}
        variants={variants}>
        <SideTail rate={rate} swing={swing} />
      </motion.g>

      <Shoulders rate={breathRate} />

      <path
        id="hair_side_left"
        d="m 964.12125,392.35166 c 0,0 8.76928,21.5349 6.9131,39.3198 -1.66269,15.93128 -15.90987,33.41081 -19.09185,46.93422 -3.182,13.52341 2.91685,26.78165 2.91685,26.78165 0,0 -20.95534,-7.49529 -14.31893,-31.02429 5.83359,-20.68288 18.49037,-26.18927 23.06931,-40.83542 5.09857,-16.30805 -2.67046,-39.3198 -2.67046,-39.3198 l 3.18197,-1.85615"
        style={{fill: matsuriColors.HAIR}} />

      <motion.g
        animate={['sway', rerenderKey]}
        style={style}
        variants={variants}>

        <defs>
          <path
            id="hair_back"
            d="m 971.56468,399.58651 c 0,0 20.15257-8.48529 19.62227-37.12311 -0.53033-28.63783 -19.09193-71.59456 -57.27572-101.82338 -38.1837-30.22881 -88.03477-46.66904 -151.14404-18.56155 -63.10928,28.10749 -71.59456,124.09724 -60.98794,163.34166 10.60659,39.24442 46.13868,73.7159 65.23061,72.65523 19.09185-1.06067 73.71584,1.06067 118.2636-21.21321 44.54768-22.27385 66.29122-57.27563 66.29122-57.27563 0,0 0,0 0,0"
            style={{fill: matsuriColors.HAIR}} />
          <path
            id="skin_face"
            d="m 904.47797,265.41299 c 29.43332,17.76605 46.93422,57.27565 52.76778,75.83719 5.83367,18.56154 15.08805,36.76944 15.87781,49.0422 0.84059,13.0631 -11.21899,46.42087 -39.18563,69.16258 -36.4847,29.66837 -94.95578,37.18193 -119.35094,23.39334 -24.39519-13.78857 -68.41259-40.30506 -76.36754-101.29303 -7.95495-60.98797 22.80419-98.11107 54.62399-114.5513 31.8198-16.44023 82.20124-19.35704 111.63453-1.59098 0,0 0,0 0,0"
            style={{fill: matsuriColors.SKIN}} />
          <path
            id="hair_bangs"
            d="m 866.8245,434.32311 c 0,0 11.40208,-12.99308 17.23575,-33.14563 5.83364,-20.15254 3.18195,-49.58586 3.18195,-49.58586 0,0 4.50782,8.48529 7.68986,15.11442 3.18195,6.62913 5.83362,18.03121 5.83362,18.03121 0,0 9.01559,-13.25823 10.87177,-28.37265 1.8561,-15.11442 -5.03821,-38.71409 -5.03821,-38.71409 0,0 12.46283,9.28077 21.21324,24.39516 8.75047,15.11442 8.75047,30.49398 8.75047,30.49398 0,0 6.36398,-1.06064 14.58405,-14.3189 8.22016,-13.25826 10.34144,-49.05553 -5.83364,-70.79907 -16.17503,-21.74352 -81.14049,-69.7384 -148.75756,-36.06244 -67.6171,33.67595 -73.98105,120.11978 -59.66215,159.09902 14.31896,38.97927 36.59275,63.90479 66.55646,67.08677 29.96362,3.18197 39.24437,0.53033 39.24437,0.53033 0,0 -14.31884,-8.75044 -23.86485,-19.62221 -9.54592,-10.87177 -14.05375,-22.0087 -14.05375,-22.0087 0,0 3.18203,-11.93244 6.09885,-34.47147 2.91682,-22.539 0.53033,-49.32068 0.53033,-49.32068 0,0 5.83364,21.74355 18.56151,44.0174 12.72796,22.27385 36.85793,37.65342 36.85793,37.65342 0,0 0,0 0,0"
            style={{fill: matsuriColors.HAIR}} />

          <clipPath id="hair_back_clip">
            <use href="#hair_back" />
          </clipPath>
          <clipPath id="skin_face_clip">
            <use href="#skin_face" />
          </clipPath>
          <clipPath id="hair_bangs_clip">
            <use href="#hair_bangs" />
          </clipPath>
        </defs>

        <path
          id="scrunchie"
          d="m 943.66777,279.1899 c -5.84237-0.69912 -9.46006-2.00814 -19.81386-7.16945 -9.94555-4.9578 -24.53355-14.78718 -31.78624-21.41755 -5.17558-4.73149 -13.63895-14.48609 -14.45159-16.65644 -0.91967-2.45618 1.4567-8.39516 4.78134-11.94947 3.69539-3.95066 5.95066-5.24374 9.1457-5.24374 1.87325,0 2.57669,0.39019 3.48965,1.93572 0,0 1.14347,1.93572 1.14347,1.93572 0,0 2.82509-2.15645 2.82509-2.15645 3.85727-2.94431 8.34608-4.1591 11.6788-3.16059 3.64017,1.09062 4.95337,2.85695 5.30858,7.14037 0,0 0.30342,3.65899 0.30342,3.65899 0,0 1.79572-0.9286 1.79572-0.9286 2.43218-1.25774 9.51605-3.05193 12.04968-3.05193 4.02987,0 6.90653,5.69166 5.55928,10.99942 -0.38058,1.4994 -0.6302,2.78794 -0.55468,2.86344 0.0754,0.07551 2.12445-0.3382 4.55326-0.91933 2.42878-0.58113 5.18465-0.86367 6.12414-0.62788 3.12148,0.78345 3.9109,5.6076 2.1657,13.235 -0.36085,1.57711 -0.13748,1.7717 2.93644,2.55955 3.63674,0.93207 6.18823,2.86088 6.16326,4.65917 -0.0085,0.63207 -0.75495,2.94694 -1.65815,5.14416 -0.90323,2.19721 -1.57612,4.05448 -1.4953,4.12726 0.08079,0.07279 1.28038,0.60204 2.66567,1.17613 1.99729,0.82771 2.5187,1.40541 2.5187,2.79056 0,2.47406 -1.71935,5.58794 -4.91445,8.90036 -2.96515,3.07402 -2.92572,3.06595 -10.5336,2.15557 0,0 0,0 0,0"
          style={{fill: matsuriColors.YELLOW}} />
        <use href="#hair_back" />
        <path
          id="hair_back_shadow"
          clipPath="url(#hair_back_clip)"
          d="m 724.43115,317.38476 c 0,0 -39.7749,112.96142 -39.7749,112.96142 0,0 151.14404,108.71776 151.14404,108.71776 0,0 56.21482-41.3657 56.21482-41.3657 0,0 -48.78952-24.92578 -48.78952-24.92578 0,0 -67.10573-12.85756 -97.3345-48.38967 -31.16358-36.63096 -21.45994-106.99804 -21.45994-106.99804 0,0 0,0 0,0"
          style={{fill: matsuriColors.HAIR_SHADOW}} />
        <motion.g
          animate={faceControl}
          style={{scaleX: 1, scaleY: 1}}
          variants={faceVariants}
          onClick={() => faceControl.start(['squashX', 'squashY'])}>
          <use href="#skin_face" />
          <path
            id="skin_face_shadow"
            clipPath="url(#skin_face_clip)"
            d="m 801.375,449.25001 c 0,0 7.5,-9.75 14.625,-28.5 6.84947,-18.02491 7.125,-27 7.125,-27 0,0 8.0779,13.68551 21,25.5 13.125,12 25.125,18 25.125,18 0,0 10.875,-12.75 18.375,-29.625 6.36031,-14.31071 7.875,-31.5 7.875,-31.5 0,0 1.5,2.25 3,6.75 1.5,4.5 1.5,8.25 1.5,8.25 0,0 9.60234,-10.16441 15.75,-28.125 5.36376,-15.6704 2.25,-27.37499 2.25,-27.37499 0,0 4.59831,5.54065 10.875,18 6.56473,13.03113 6,23.99999 6,23.99999 0,0 9.20381,-4.12242 18,-13.5 9.75231,-10.3969 11.625,-25.87499 11.625,-25.87499 0,0 -51.375,-67.5 -124.125,-40.875 -72.75,26.625 -39,151.87499 -39,151.87499 z"
            style={{fill: matsuriColors.SKIN_SHADOW}} />
        </motion.g>
        <use href="#hair_bangs" />
        <path
          id="hair_bangs_shadow"
          clipPath="url(#hair_bangs_clip)"
          d="m 730.21119,356.58102 c 0,0 2.06294,44.85549 39.33547,80.95853 33.3934,32.34566 90.11835,49.55139 90.11835,49.55139 0,0 25.45591,40.83542 25.45591,40.83542 0,0 -94.39875,32.88047 -136.82517,-19.09188 -42.4264,-51.97235 -18.08456,-152.25347 -18.08456,-152.25347 0,0 0,0 0,0"
          style={{fill: matsuriColors.HAIR_SHADOW}} />
        <path
          id="eyes"
          d="m 835.30037,462.49019 c -1.91673,-1.11419 -3.40067,-5.15316 -2.35585,-6.41211 0.46128,-0.55579 4.34548,-2.76846 8.63161,-4.917 4.2861,-2.14858 8.2006,-4.3977 8.69888,-4.9981 0.49827,-0.60041 1.09763,-3.1824 1.33183,-5.7378 0.23414,-2.5554 0.59726,-4.81757 0.80671,-5.02702 0.20948,-0.20948 1.257,0.076 2.32784,0.63451 2.92175,1.78421 4.39934,3.04906 6.18457,4.40014 0,0 3.59028,-3.23096 3.59028,-3.23096 6.62882,-5.9654 7.0541,-6.20235 9.20611,-5.12878 1.04003,0.51883 2.43034,1.53933 3.08957,2.26774 1.13936,1.25901 1.14174,1.46645 0.0482,4.19944 -4.80963,12.02043 -14.11551,19.49905 -28.64268,23.01854 -7.51204,1.81993 -10.96075,2.06861 -12.91708,0.93141 0,0 3e-5,0 3e-5,0 m -28.29152,-41.04989 c 0.2622,-1.57 1.01534,-4.22751 1.67346,-5.90559 5.43246,-13.85178 26.42343,-36.2408 33.97782,-36.2408 3.121,0 2.85012,1.03759 -0.83716,3.20692 -5.96395,3.5087 -12.13614,8.81654 -17.08214,14.69001 -6.71343,7.9723 -9.8339,12.77538 -13.3545,20.55538 -3.21024,7.09413 -5.23029,8.79883 -4.37749,3.69408 0,0 0,0 0,0 m 117.00128,-17.71605 c -0.19871,-0.32261 -0.57036,-1.98383 -0.82593,-3.69162 -0.53478,-3.57335 0.11735,-4.46057 6.16643,-8.3878 1.91494,-1.24325 3.67053,-2.56595 3.90129,-2.93933 0.34929,-0.56517 0.59511,-3.08611 0.96695,-9.91534 0.0624,-1.14727 1.79212,-1.05321 5.30538,0.28851 0,0 2.95379,1.12808 2.95379,1.12808 0,0 5.46437,-5.84317 5.46437,-5.84317 3.00538,-3.21372 5.8055,-5.83707 6.22244,-5.82965 0.41692,0.009 1.1554,0.99578 1.641,2.19637 0.4856,1.20059 1.18817,2.3898 1.56129,2.64271 0.98974,0.6709 -1.21912,7.27934 -4.53073,13.55482 -1.91344,3.62599 -4.10153,6.51266 -6.97572,9.20288 -3.57537,3.34653 -4.99961,4.17691 -9.73902,5.67828 -6.18046,1.95786 -11.56127,2.80877 -12.11156,1.91526 0,0 0,0 0,0 M 895.6125,349.56439 c -0.62266,-1.62264 0.6258,-3.37357 4.53135,-6.35516 5.15186,-3.93304 10.20458,-5.88906 17.05235,-7.52207 11.75326,-2.8029 27.15922,-3.99903 27.40895,-1.77829 0.1063,0.94595 -3.07103,1.60067 -11.63296,2.397 -8.98872,0.83602 -14.69597,2.03766 -20.95563,4.41215 -5.09664,1.93329 -11.49993,5.62419 -14.16946,8.16732 -1.53638,1.46361 -1.89204,1.5717 -2.23461,0.67904 0,0 0,0 0,0"
          style={{fill: matsuriColors.EYES}} />
        <motion.path
          id="hair_ahoge"
          d="m 787.875,167.625 c 0,0 -18.82176,15.7584 -29.06249,39 -11.4834,26.06178 -7.4245,45.73856 -0.56251,52.875 14.06248,14.625 52.125,12.375 52.125,12.375 0,0 -22.99119,-17.31981 -28.12501,-40.875 -6.375,-29.25 5.62501,-63.375 5.62501,-63.375 0,0 0,0 0,0"
          animate={ahogeControl}
          variants={ahogeVariants}
          onMouseOver={() => ahogeControl.start('largeFlick').then(ahogeLoop)}
          style={{fill: matsuriColors.HAIR, originX: '810px', originY: '270px'}} />

      </motion.g>
    </React.Fragment>
  );
}
